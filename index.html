<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Créateur de Prompts IA</title>
    <style>
        /* Reset et base */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .app {
            display: flex;
            height: 100vh;
            background: white;
            margin: 20px;
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .sidebar h2 {
            color: #1e293b;
            margin-bottom: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            background: transparent;
            border: none;
            width: 100%;
            text-align: left;
            font-size: 14px;
            color: #64748b;
        }

        .nav-item:hover {
            background: white;
            color: #1e293b;
            transform: translateX(4px);
        }

        .nav-item.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
        }

        .nav-icon {
            margin-right: 12px;
            font-size: 16px;
        }

        /* Main content */
        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
            background: #fafbfc;
        }

        .page-header {
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: #64748b;
            font-size: 16px;
        }

        /* Wizard Steps */
        .wizard-container {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.05);
        }

        .steps-indicator {
            display: flex;
            justify-content: space-between;
            margin-bottom: 40px;
            position: relative;
        }

        .step {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            position: relative;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #e2e8f0;
            color: #64748b;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .step.active .step-number {
            background: #3b82f6;
            color: white;
            transform: scale(1.1);
        }

        .step.completed .step-number {
            background: #10b981;
            color: white;
        }

        .step-label {
            font-size: 12px;
            color: #64748b;
            text-align: center;
            max-width: 80px;
        }

        /* Form styles */
        .form-group {
            margin-bottom: 24px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
            transition: all 0.2s;
            background: white;
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .button-group {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 30px;
        }

        .btn {
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
            font-size: 14px;
        }
        
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background: #2563eb;
            transform: translateY(-1px);
        }

        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        /* Quality Analyzer */
        .quality-analyzer {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #0ea5e9;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
        }

        .quality-score {
            display: flex;
            align-items: center;
            margin-bottom: 16px;
        }

        .score-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 18px;
            margin-right: 16px;
            color: white;
        }

        .score-excellent { background: #10b981; }
        .score-good { background: #3b82f6; }
        .score-average { background: #f59e0b; }
        .score-poor { background: #ef4444; }

        .suggestions-list {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        .suggestion-item {
            padding: 8px 0;
            color: #0c4a6e;
            font-size: 14px;
            display: flex;
            align-items: flex-start;
        }

        .suggestion-item::before {
            content: '💡';
            margin-right: 8px;
            margin-top: 2px;
        }

        /* Hidden sections */
        .hidden {
            display: none;
        }

        /* Stats box */
        .stats-box {
            margin-top: auto; /* Pushes to the bottom */
            padding: 16px;
            background: #f1f5f9;
            border-radius: 8px;
            font-size: 14px;
        }

        .stats-box h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
        }

        .stats-box p {
            margin: 0;
            color: #64748b;
        }
        
        /* Library Section */
        .library-container {
            display: flex;
            gap: 20px;
            height: 100%;
        }
        
        .folder-sidebar {
            width: 220px;
            flex-shrink: 0;
            border-right: 1px solid #e2e8f0;
            padding-right: 20px;
        }
        
        .folder-sidebar h3 {
            font-size: 16px;
            margin-bottom: 16px;
            color: #1e293b;
        }
        
        .folder-list {
            list-style: none;
        }
        
        .folder-item {
            padding: 10px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 4px;
            font-size: 14px;
            color: #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .folder-item:hover {
            background: #f1f5f9;
        }
        
        .folder-item.active {
            background: #e0f2fe;
            color: #0c4a6e;
            font-weight: 600;
        }
        
        .delete-folder-btn {
            background: none;
            border: none;
            color: #9ca3af;
            cursor: pointer;
            visibility: hidden;
            opacity: 0;
            transition: all 0.2s;
        }
        
        .folder-item:hover .delete-folder-btn {
            visibility: visible;
            opacity: 1;
        }
        
        .delete-folder-btn:hover {
            color: #ef4444;
        }
        
        .prompt-list-container {
            flex-grow: 1;
        }
        
        .library-controls {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .prompt-card {
            background: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
            cursor: pointer;
            transition: box-shadow 0.2s, transform 0.2s;
        }
        
        .prompt-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            transform: translateY(-2px);
        }
        
        .prompt-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }
        
        .prompt-card-title {
            margin: 0;
            color: #1e293b;
            font-weight: 600;
        }
        
        .prompt-card-category {
            font-size: 12px;
            color: #64748b;
            background: #e2e8f0;
            padding: 4px 8px;
            border-radius: 12px;
            flex-shrink: 0;
        }
        
        .prompt-card-content {
            font-size: 14px;
            color: #475569;
            margin-bottom: 16px;
            white-space: pre-wrap;
            max-height: 100px;
            overflow: hidden;
            text-overflow: ellipsis;
            line-height: 1.5;
        }
        
        .prompt-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .prompt-card-date {
            color: #64748b;
            font-size: 12px;
        }
        
        .prompt-card-actions {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(17, 24, 39, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
        }

        .modal-overlay:not(.hidden) {
            opacity: 1;
            visibility: visible;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            transform: scale(0.95);
            transition: transform 0.3s;
        }

        .modal-overlay:not(.hidden) .modal-content {
            transform: scale(1);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .modal-title {
            font-size: 20px;
            color: #1e293b;
        }
        
        .modal-close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: #64748b;
            line-height: 1;
        }
        
        .modal-body {
            overflow-y: auto;
            white-space: pre-wrap; /* Respect newlines */
            background: #f8fafc;
            padding: 20px;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
            color: #374151;
            line-height: 1.6;
        }

        /* Toast Notifications */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background-color: #333;
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.3s ease-out, transform 0.3s ease-out;
            min-width: 250px;
            max-width: 350px;
            display: flex;
            align-items: center;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
        }

        .toast.success {
            background-color: #10b981; /* Green */
        }

        .toast.error {
            background-color: #ef4444; /* Red */
        }

        .toast.info {
            background-color: #3b82f6; /* Blue */
        }

        .toast-icon {
            margin-right: 10px;
            font-size: 18px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app {
                margin: 0;
                border-radius: 0;
                flex-direction: column;
                height: 100vh;
            }

            .sidebar {
                width: 100%;
                height: auto;
                order: 2;
                flex-direction: row;
                align-items: center;
                padding: 10px;
            }
            
            .sidebar h2 {
                display: none;
            }
            
            .stats-box {
                margin-top: 0;
                margin-left: auto;
            }

            .main-content {
                order: 1;
                flex: 1;
                padding: 20px;
            }
            
            .library-container {
                flex-direction: column;
            }
            
            .folder-sidebar {
                width: 100%;
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
                padding-right: 0;
                padding-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="app">
        <div class="sidebar">
            <h2>Créateur de Prompts IA</h2>
            <button class="nav-item active" data-tab="creator"><span class="nav-icon">🚀</span> Assistant</button>
            <button class="nav-item" data-tab="freeform"><span class="nav-icon">📝</span> Saisie Libre</button>
            <button class="nav-item" data-tab="library"><span class="nav-icon">📚</span> Mes Prompts</button>
            <button class="nav-item" data-tab="help"><span class="nav-icon">❓</span> Guide</button>
            <div class="stats-box">
                <h4>📊 Vos prompts</h4>
                <p id="prompt-count">0 prompt sauvegardé</p>
            </div>
        </div>
        <div class="main-content">
            <!-- Section Assistant de Création -->
            <div id="creator-section">
                <div class="page-header">
                    <h1 class="page-title">Assistant de Création de Prompts</h1>
                    <p class="page-subtitle">Créez des prompts efficaces étape par étape</p>
                </div>
                <div class="wizard-container">
                    <div class="steps-indicator">
                        <div class="step active" data-step="0"><div class="step-number">1</div><div class="step-label">Rôle</div></div>
                        <div class="step" data-step="1"><div class="step-number">2</div><div class="step-label">Objectif</div></div>
                        <div class="step" data-step="2"><div class="step-number">3</div><div class="step-label">Contexte</div></div>
                        <div class="step" data-step="3"><div class="step-number">4</div><div class="step-label">Structure</div></div>
                        <div class="step" data-step="4"><div class="step-number">5</div><div class="step-label">Exemples</div></div>
                        <div class="step" data-step="5"><div class="step-number">6</div><div class="step-label">Contraintes</div></div>
                    </div>
                    <h3 id="step-title">Quel rôle doit jouer l'IA ?</h3>
                    <div id="step-0" class="step-content">
                        <div class="form-group"><label class="form-label">Quel rôle doit jouer l'IA ?</label><textarea id="role" class="form-textarea" placeholder="Ex: Tu es un expert développeur Python..."></textarea></div>
                        <div class="form-group"><label class="form-label">Rôles suggérés</label><select id="role-suggestions" class="form-select"><option value="">Choisir un rôle prédéfini (optionnel)</option><option value="expert-dev">Expert développeur</option><option value="consultant">Consultant en stratégie</option><option value="professeur">Professeur pédagogue</option><option value="redacteur">Rédacteur professionnel</option></select></div>
                    </div>
                    <div id="step-1" class="step-content hidden">
                        <div class="form-group"><label class="form-label">Que voulez-vous que l'IA fasse ?</label><textarea id="objective" class="form-textarea" placeholder="Ex: Crée une fonction Python..."></textarea></div>
                        <div class="form-group"><label class="form-label">Catégorie</label><select id="category" class="form-select"><option value="général">Général</option><option value="code">Programmation</option><option value="rédaction">Rédaction</option><option value="analyse">Analyse</option><option value="créatif">Créatif</option></select></div>
                    </div>
                    <div id="step-2" class="step-content hidden"><div class="form-group"><label class="form-label">Décrivez le contexte</label><textarea id="context" class="form-textarea" placeholder="Ex: Je travaille sur un projet..."></textarea></div></div>
                    <div id="step-3" class="step-content hidden"><div class="form-group"><label class="form-label">Structure de la réponse</label><textarea id="structure" class="form-textarea" placeholder="Ex: Code commenté, puis explication..."></textarea></div></div>
                    <div id="step-4" class="step-content hidden"><div class="form-group"><label class="form-label">Exemples (Optionnel)</label><textarea id="examples" class="form-textarea" placeholder="Ex: factorielle(5) -> 120..."></textarea></div></div>
                    <div id="step-5" class="step-content hidden"><div class="form-group"><label class="form-label">Contraintes (Optionnel)</label><textarea id="constraints" class="form-textarea" placeholder="Ex: Utiliser uniquement les bibliothèques standard..."></textarea></div></div>
                    <div id="quality-analyzer" class="quality-analyzer hidden"><div class="quality-score"><div id="score-circle" class="score-circle score-poor">0/5</div><div><h4 id="score-label">Qualité : À améliorer</h4><p>Votre prompt est analysé en temps réel</p></div></div><div id="suggestions-container" class="hidden"><h5>Suggestions d'amélioration :</h5><ul id="suggestions-list" class="suggestions-list"></ul></div></div>
                    <div class="button-group"><button id="prev-btn" class="btn btn-secondary hidden">Précédent</button><button id="next-btn" class="btn btn-primary">Suivant</button></div>
                </div>
            </div>

            <!-- Section Saisie Libre -->
            <div id="freeform-section" class="hidden">
                <div class="page-header">
                    <h1 class="page-title">Saisie Libre de Prompt</h1>
                    <p class="page-subtitle">Collez ou écrivez votre prompt et sauvegardez-le</p>
                </div>
                <div class="wizard-container">
                    <div class="form-group">
                        <label class="form-label">Votre Prompt :</label>
                        <textarea id="freeform-prompt-content" class="form-textarea" rows="15" placeholder="Collez ou écrivez votre prompt ici..."></textarea>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Titre du Prompt (optionnel) :</label>
                        <input type="text" id="freeform-prompt-title" class="form-input" placeholder="Un titre pour votre prompt...">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Catégorie (optionnel) :</label>
                        <select id="freeform-prompt-category" class="form-select">
                            <option value="général">Général</option>
                            <option value="code">Programmation</option>
                            <option value="rédaction">Rédaction</option>
                            <option value="analyse">Analyse</option>
                            <option value="créatif">Créatif</option>
                        </select>
                    </div>
                    <div class="button-group">
                        <button id="save-freeform-btn" class="btn btn-primary">Sauvegarder le Prompt</button>
                    </div>
                </div>
            </div>

            <!-- Section Bibliothèque de Prompts -->
            <div id="library-section" class="hidden">
                <div class="page-header">
                    <h1 class="page-title">Mes Prompts Sauvegardés</h1>
                    <p class="page-subtitle">Gérez, recherchez et réutilisez vos prompts</p>
                </div>
                <div class="wizard-container library-container">
                    <div class="folder-sidebar">
                        <h3>Dossiers</h3>
                        <ul id="folder-list" class="folder-list"></ul>
                        <button id="new-folder-btn" class="btn btn-secondary" style="width: 100%; margin-top: 16px;">+ Nouveau Dossier</button>
                        <div style="margin-top: 20px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                            <button id="export-data-btn" class="btn btn-secondary btn-sm" style="width: 100%; margin-bottom: 10px;">Exporter les données</button>
                            <input type="file" id="import-data-input" accept=".json" style="display: none;">
                            <button id="import-data-btn" class="btn btn-secondary btn-sm" style="width: 100%;">Importer les données</button>
                        </div>
                    </div>
                    <div class="prompt-list-container">
                        <div class="library-controls">
                            <input type="text" id="search-input" class="form-input" placeholder="Rechercher un prompt..." style="flex-grow: 1;">
                            <select id="sort-select" class="form-select" style="width: 200px;">
                                <option value="newest">Plus récents d'abord</option>
                                <option value="oldest">Plus anciens d'abord</option>
                                <option value="title-asc">Titre (A-Z)</option>
                                <option value="title-desc">Titre (Z-A)</option>
                            </select>
                        </div>
                        <div id="prompt-library-list"></div>
                    </div>
                </div>
            </div>
            <div id="help-section" class="hidden">
                 <div class="page-header"><h2 class="page-title">Guide d'utilisation</h2><p class="page-subtitle">Comment créer des prompts efficaces</p></div>
                 <div class="wizard-container"><p>Contenu du guide...</p></div>
            </div>
        </div>
    </div>
    <div id="prompt-modal" class="modal-overlay hidden">
        <div class="modal-content">
            <div class="modal-header"><h3 id="modal-title" class="modal-title">Titre du Prompt</h3><button id="modal-close-btn" class="modal-close-btn">&times;</button></div>
            <div id="modal-body" class="modal-body"></div>
        </div>
    </div>

    <!-- Toast Container -->
    <div id="toast-container"></div>

    <script>
        // =================================================================================
        // STATE & CONFIG
        // =================================================================================
        let currentStep = 0;
        let formData = { role: '', objective: '', context: '', structure: '', examples: '', constraints: '', category: 'général' };
        let currentFolderId = 'all';

        const steps = [
            { key: 'role', title: 'Quel rôle doit jouer l\'IA ?' },
            { key: 'objective', title: 'Quel est votre objectif ?' },
            { key: 'context', title: 'Quel contexte l\'IA doit-elle connaître ?' },
            { key: 'structure', title: 'Comment structurer la réponse ?' },
            { key: 'examples', title: 'Avez-vous des exemples ?' },
            { key: 'constraints', title: 'Des contraintes spécifiques ?' }
        ];
        
        const predefinedRoles = {
            'expert-dev': 'Tu es un expert développeur avec 10+ ans d\'expérience en programmation. Tu maîtrises les bonnes pratiques, l\'architecture logicielle et l\'optimisation de code.',
            'consultant': 'Tu es un consultant en stratégie d\'entreprise avec une expertise en transformation digitale et amélioration des processus.',
            'professeur': 'Tu es un professeur pédagogue qui sait expliquer des concepts complexes de manière simple et accessible, avec des exemples concrets.',
            'redacteur': 'Tu es un rédacteur professionnel spécialisé dans la création de contenu engageant, optimisé SEO et adapté à différents publics.'
        };

        // =================================================================================
        // LOCAL STORAGE UTILITIES
        // =================================================================================
        const storage = {
            getPrompts: () => JSON.parse(localStorage.getItem('prompts')) || [],
            savePrompts: (prompts) => localStorage.setItem('prompts', JSON.stringify(prompts)),
            getFolders: () => JSON.parse(localStorage.getItem('prompt_folders')) || [],
            saveFolders: (folders) => localStorage.setItem('prompt_folders', JSON.stringify(folders)),

            savePrompt: function(promptData) {
                const prompts = this.getPrompts();
                const newPrompt = { id: Date.now().toString(), createdAt: new Date().toISOString(), folderId: null, ...promptData };
                prompts.push(newPrompt);
                this.savePrompts(prompts);
                return newPrompt;
            },
            
            updatePrompt: function(updatedPrompt) {
                let prompts = this.getPrompts();
                const index = prompts.findIndex(p => p.id === updatedPrompt.id);
                if (index !== -1) {
                    prompts[index] = { ...prompts[index], ...updatedPrompt, updatedAt: new Date().toISOString() };
                    this.savePrompts(prompts);
                    return true;
                }
                return false;
            },

            deletePrompt: function(id) {
                this.savePrompts(this.getPrompts().filter(p => p.id !== id));
            },

            updatePromptFolder: function(promptId, folderId) {
                const prompts = this.getPrompts();
                const promptIndex = prompts.findIndex(p => p.id === promptId);
                if (promptIndex > -1) {
                    prompts[promptIndex].folderId = folderId === 'null' ? null : folderId;
                    this.savePrompts(prompts);
                }
            },

            saveFolder: function(folderName) {
                const folders = this.getFolders();
                const newFolder = { id: Date.now().toString(), name: folderName };
                folders.push(newFolder);
                this.saveFolders(folders);
                return newFolder;
            },

            deleteFolder: function(folderId) {
                this.saveFolders(this.getFolders().filter(f => f.id !== folderId));
                const prompts = this.getPrompts();
                prompts.forEach(p => { if (p.folderId === folderId) p.folderId = null; });
                this.savePrompts(prompts);
            }
        };

        // =================================================================================
        // PROMPT WIZARD & QUALITY ANALYSIS
        // =================================================================================
        function analyzePrompt(prompt) {
            const analysis = { score: 0, issues: [], suggestions: [] };
            if (!prompt || prompt.trim().length === 0) return { score: 0, issues: ['Prompt vide'], suggestions: ['Commencez par définir un rôle pour l\'IA'] };
            let score = 5;
            if (!/\b(tu es|vous êtes|agis comme|joue le rôle|expert|spécialiste|professionnel)\b/i.test(prompt)) { analysis.issues.push('Aucun rôle défini'); analysis.suggestions.push('Commencez par "Tu es un expert en..." ou "Agis comme..."'); score--; }
            if (!/\b(je veux|génère|crée|écris|analyse|explique|aide|fais|objectif)\b/i.test(prompt)) { analysis.issues.push('Objectif peu clair'); analysis.suggestions.push('Précisez clairement ce que vous voulez que l\'IA fasse'); score--; }
            if (prompt.length < 80) { analysis.issues.push('Manque de contexte'); analysis.suggestions.push('Ajoutez plus de détails sur le contexte et vos attentes'); score--; }
            if (prompt.length > 150 && !prompt.includes('\n') && !prompt.includes('.')) { analysis.suggestions.push('Structurez avec des sauts de ligne ou des points'); score -= 0.5; }
            if (/\b(chose|truc|quelque chose|bien|bon)\b/i.test(prompt)) { analysis.issues.push('Termes trop vagues'); analysis.suggestions.push('Remplacez les termes vagues par des descriptions précises'); score--; }
            analysis.score = Math.max(0, Math.min(5, Math.round(score * 10) / 10));
            return analysis;
        }

        function updateQualityAnalyzer() {
            const prompt = getPromptPreview();
            document.getElementById('quality-analyzer').classList.toggle('hidden', !prompt);
            if (!prompt) return;
            const analysis = analyzePrompt(prompt);
            document.getElementById('score-circle').textContent = analysis.score + '/5';
            document.getElementById('score-circle').className = 'score-circle ' + getScoreClass(analysis.score);
            document.getElementById('score-label').textContent = 'Qualité : ' + getScoreLabel(analysis.score);
            const suggestionsContainer = document.getElementById('suggestions-container');
            suggestionsContainer.classList.toggle('hidden', analysis.suggestions.length === 0);
            const suggestionsList = document.getElementById('suggestions-list');
            suggestionsList.innerHTML = '';
            analysis.suggestions.forEach(suggestion => { suggestionsList.innerHTML += `<li class="suggestion-item">${suggestion}</li>`; });
        }

        function getScoreClass(score) { if (score >= 4.5) return 'score-excellent'; if (score >= 3.5) return 'score-good'; if (score >= 2) return 'score-average'; return 'score-poor'; }
        function getScoreLabel(score) { if (score >= 4.5) return 'Excellent'; if (score >= 3.5) return 'Bon'; if (score >= 2) return 'Moyen'; return 'À améliorer'; }

        function getPromptPreview() {
            return [
                formData.role, 
                formData.objective ? `Objectif: ${formData.objective}` : '',
                formData.context ? `Contexte: ${formData.context}` : '',
                formData.structure ? `Structure: ${formData.structure}` : '',
                formData.examples ? `Exemples: ${formData.examples}` : '',
                formData.constraints ? `Contraintes: ${formData.constraints}` : ''
            ].filter(Boolean).join('\n\n');
        }

        function updateStepDisplay() {
            document.querySelectorAll('.step-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`step-${currentStep}`).classList.remove('hidden');
            document.getElementById('step-title').textContent = steps[currentStep].title;
            document.querySelectorAll('.step').forEach((el, idx) => { el.classList.remove('active', 'completed'); if (idx === currentStep) el.classList.add('active'); else if (idx < currentStep) el.classList.add('completed'); });
            document.getElementById('prev-btn').classList.toggle('hidden', currentStep === 0);
            document.getElementById('next-btn').textContent = (currentStep === steps.length - 1) ? 'Créer le Prompt' : 'Suivant';
            document.getElementById('next-btn').disabled = false; // Always enabled for optional steps
        }

        function nextStep() { if (currentStep < steps.length - 1) { currentStep++; updateStepDisplay(); } else { generatePrompt(); } }
        function prevStep() { if (currentStep > 0) { currentStep--; updateStepDisplay(); } }

        function generatePrompt() {
            storage.savePrompt({ title: (formData.objective || 'Nouveau Prompt').substring(0, 40) + '...', content: getPromptPreview(), category: formData.category, tags: ['wizard-generated'] });
            showToast('Prompt créé avec succès !', 'success');
            resetForm();
            updatePromptCount();
        }

        function resetForm() {
            currentStep = 0;
            formData = { role: '', objective: '', context: '', structure: '', examples: '', constraints: '', category: 'général' };
            ['role', 'objective', 'context', 'structure', 'examples', 'constraints'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('category').value = 'général';
            document.getElementById('role-suggestions').value = '';
            updateStepDisplay();
            updateQualityAnalyzer();
        }

        // =================================================================================
        // FREEFORM PROMPT INPUT
        // =================================================================================
        function saveFreeformPrompt() {
            const content = document.getElementById('freeform-prompt-content').value.trim();
            let title = document.getElementById('freeform-prompt-title').value.trim();
            const category = document.getElementById('freeform-prompt-category').value;

            if (!content) {
                showToast('Veuillez saisir un prompt pour le sauvegarder.', 'error');
                return;
            }

            if (!title) {
                title = content.substring(0, 40) + (content.length > 40 ? '...' : '');
            }

            storage.savePrompt({ title: title, content: content, category: category, tags: ['freeform'] });
            showToast('Prompt sauvegardé avec succès !', 'success');
            document.getElementById('freeform-prompt-content').value = '';
            document.getElementById('freeform-prompt-title').value = '';
            updatePromptCount();
        }

        // =================================================================================
        // PROMPT LIBRARY & FOLDERS
        // =================================================================================
        function renderPromptLibrary() {
            const listContainer = document.getElementById('prompt-library-list');
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const sortValue = document.getElementById('sort-select').value;
            let prompts = storage.getPrompts();

            if (currentFolderId === 'uncategorized') prompts = prompts.filter(p => !p.folderId);
            else if (currentFolderId !== 'all') prompts = prompts.filter(p => p.folderId === currentFolderId);
            if (searchTerm) prompts = prompts.filter(p => p.title.toLowerCase().includes(searchTerm) || p.content.toLowerCase().includes(searchTerm));
            
            prompts.sort((a, b) => {
                switch (sortValue) {
                    case 'oldest': return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'title-asc': return a.title.localeCompare(b.title);
                    case 'title-desc': return b.title.localeCompare(a.title);
                    default: return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });

            listContainer.innerHTML = prompts.length === 0 ? '<p style="text-align: center; color: #64748b; padding: 40px 0;">Aucun prompt trouvé.</p>' : '';
            const folders = storage.getFolders();
            prompts.forEach(prompt => {
                const folderOptions = folders.map(f => `<option value="${f.id}" ${prompt.folderId === f.id ? 'selected' : ''}>${f.name}</option>`).join('');
                const selectHTML = `<select class="form-select btn-sm" data-action="move"><option value="null" ${!prompt.folderId ? 'selected' : ''}>Non classé</option>${folderOptions}</select>`;
                const card = document.createElement('div');
                card.className = 'prompt-card';
                card.dataset.id = prompt.id;
                card.innerHTML = `
                    <div class="prompt-card-header"><h4 class="prompt-card-title">${prompt.title}</h4><span class="prompt-card-category">${prompt.category}</span></div>
                    <p class="prompt-card-content">${prompt.content}</p>
                    <div class="prompt-card-footer">
                        <small class="prompt-card-date">Créé le: ${new Date(prompt.createdAt).toLocaleDateString('fr-FR')}</small>
                        <div class="prompt-card-actions">
                            ${selectHTML}
                            <button class="btn btn-secondary btn-sm" data-action="edit">Modifier</button>
                            <button class="btn btn-secondary btn-sm" data-action="copy">Copier</button>
                            <button class="btn btn-secondary btn-sm" data-action="delete" style="background-color: #fee2e2; color: #ef4444;">Supprimer</button>
                        </div>
                    </div>`;
                listContainer.appendChild(card);
            });
        }

        function renderFolders() {
            const folderList = document.getElementById('folder-list');
            const folders = storage.getFolders();
            folderList.innerHTML = `<li class="folder-item ${currentFolderId === 'all' ? 'active' : ''}" data-id="all">Tous les prompts</li><li class="folder-item ${currentFolderId === 'uncategorized' ? 'active' : ''}" data-id="uncategorized">Non classés</li>`;
            folders.forEach(folder => { folderList.innerHTML += `<li class="folder-item ${currentFolderId === folder.id ? 'active' : ''}" data-id="${folder.id}"><span>${folder.name}</span><button class="delete-folder-btn" data-id="${folder.id}">&times;</button></li>`; });
        }

        // =================================================================================
        // IMPORT / EXPORT DATA
        // =================================================================================
        function exportData() {
            try {
                const data = {
                    prompts: storage.getPrompts(),
                    folders: storage.getFolders()
                };
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'prompts_data.json';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showToast('Données exportées avec succès !', 'success');
            } catch (error) {
                showToast('Erreur lors de l\'exportation des données.', 'error');
                console.error('Export error:', error);
            }
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.prompts && importedData.folders) {
                        if (confirm('Ceci va remplacer vos prompts et dossiers existants. Continuer ?')) {
                            storage.savePrompts(importedData.prompts);
                            storage.saveFolders(importedData.folders);
                            showToast('Données importées avec succès !', 'success');
                            updatePromptCount();
                            renderFolders();
                            renderPromptLibrary();
                        }
                    } else {
                        showToast('Fichier JSON invalide : structure attendue {prompts: [], folders: []}.', 'error');
                    }
                } catch (error) {
                    showToast('Erreur lors de la lecture du fichier JSON : ' + error.message, 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        // =================================================================================
        // MODAL
        // =================================================================================
        function openPromptModal(promptId) { 
            const prompt = storage.getPrompts().find(p => p.id === promptId); 
            if (!prompt) return; 
            document.getElementById('modal-title').textContent = prompt.title; 
            document.getElementById('modal-body').textContent = prompt.content; 
            document.getElementById('prompt-modal').classList.remove('hidden'); 
        }
        function closePromptModal() { 
            document.getElementById('prompt-modal').classList.add('hidden'); 
        }

        // =================================================================================
        // TOAST NOTIFICATIONS
        // =================================================================================
        function showToast(message, type = 'info', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            
            let icon = '';
            if (type === 'success') icon = '✔️';
            else if (type === 'error') icon = '❌';
            else icon = 'ℹ️';

            toast.innerHTML = `<span class="toast-icon">${icon}</span>${message}`;
            
            toastContainer.appendChild(toast);

            // Force reflow to enable transition
            void toast.offsetWidth;
            toast.classList.add('show');

            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }

        // =================================================================================
        // UI & GENERAL
        // =================================================================================
        function updatePromptCount() { 
            const count = storage.getPrompts().length; 
            document.getElementById('prompt-count').textContent = `${count} prompt${count > 1 ? 's' : ''} sauvegardé${count > 1 ? 's' : ''}`; 
        }

        function switchTab(tabName) {
            ['creator', 'freeform', 'library', 'help'].forEach(id => document.getElementById(id + '-section').classList.add('hidden'));
            document.getElementById(tabName + '-section').classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            if (tabName === 'library') { currentFolderId = 'all'; renderFolders(); renderPromptLibrary(); }
        }

        // =================================================================================
        // PROMPT EDITING
        // =================================================================================
        let editingPromptId = null; // To store the ID of the prompt being edited

        function startEditingPrompt(promptId) {
            const promptToEdit = storage.getPrompts().find(p => p.id === promptId);
            if (!promptToEdit) {
                showToast('Prompt non trouvé pour édition.', 'error');
                return;
            }

            // Switch to freeform tab and populate fields
            switchTab('freeform');
            document.getElementById('freeform-prompt-content').value = promptToEdit.content;
            document.getElementById('freeform-prompt-title').value = promptToEdit.title;
            document.getElementById('freeform-prompt-category').value = promptToEdit.category;

            // Change save button to update button
            const saveBtn = document.getElementById('save-freeform-btn');
            saveBtn.textContent = 'Mettre à jour le Prompt';
            saveBtn.dataset.action = 'update';
            editingPromptId = promptId; // Store the ID
        }

        function updateExistingPrompt() {
            const content = document.getElementById('freeform-prompt-content').value.trim();
            let title = document.getElementById('freeform-prompt-title').value.trim();
            const category = document.getElementById('freeform-prompt-category').value;

            if (!content) {
                showToast('Veuillez saisir un prompt pour le sauvegarder.', 'error');
                return;
            }

            if (!title) {
                title = content.substring(0, 40) + (content.length > 40 ? '...' : '');
            }

            const updatedPrompt = {
                id: editingPromptId,
                title: title,
                content: content,
                category: category
            };

            if (storage.updatePrompt(updatedPrompt)) {
                showToast('Prompt mis à jour avec succès !', 'success');
                // Reset freeform form and switch back to library
                resetFreeformForm();
                switchTab('library');
            } else {
                showToast('Erreur lors de la mise à jour du prompt.', 'error');
            }
        }

        function resetFreeformForm() {
            document.getElementById('freeform-prompt-content').value = '';
            document.getElementById('freeform-prompt-title').value = '';
            document.getElementById('freeform-prompt-category').value = 'général';
            const saveBtn = document.getElementById('save-freeform-btn');
            saveBtn.textContent = 'Sauvegarder le Prompt';
            saveBtn.dataset.action = 'save';
            editingPromptId = null;
        }

        // =================================================================================
        // EVENT LISTENERS
        // =================================================================================
        function setupEventListeners() {
            // Wizard listeners
            document.getElementById('role').addEventListener('input', function() { formData.role = this.value; updateQualityAnalyzer(); updateStepDisplay(); });
            document.getElementById('role-suggestions').addEventListener('change', function() { if (this.value && predefinedRoles[this.value]) { document.getElementById('role').value = predefinedRoles[this.value]; formData.role = predefinedRoles[this.value]; updateQualityAnalyzer(); updateStepDisplay(); } });
            document.getElementById('objective').addEventListener('input', function() { formData.objective = this.value; updateQualityAnalyzer(); updateStepDisplay(); });
            ['context', 'structure', 'examples', 'constraints'].forEach(id => document.getElementById(id).addEventListener('input', function() { formData[id] = this.value; updateQualityAnalyzer(); }));
            document.getElementById('category').addEventListener('change', function() { formData.category = this.value; });
            document.getElementById('next-btn').addEventListener('click', nextStep);
            document.getElementById('prev-btn').addEventListener('click', prevStep);
            
            // Freeform listeners
            document.getElementById('save-freeform-btn').addEventListener('click', (e) => {
                if (e.target.dataset.action === 'update') {
                    updateExistingPrompt();
                } else {
                    saveFreeformPrompt();
                }
            });

            // Library listeners
            document.getElementById('search-input').addEventListener('input', renderPromptLibrary);
            document.getElementById('sort-select').addEventListener('change', renderPromptLibrary);
            document.getElementById('new-folder-btn').addEventListener('click', () => { 
                const name = prompt('Nom du nouveau dossier:'); 
                if (name && name.trim()) { 
                    storage.saveFolder(name.trim()); 
                    renderFolders(); 
                    showToast('Dossier créé !', 'success');
                } else if (name !== null) {
                    showToast('Nom de dossier invalide.', 'error');
                }
            });
            
            // Folder list listeners
            document.getElementById('folder-list').addEventListener('click', e => {
                const delBtn = e.target.closest('.delete-folder-btn');
                const item = e.target.closest('.folder-item');
                if (delBtn) { 
                    e.stopPropagation(); // Prevent folder selection
                    if (confirm('Supprimer ce dossier ? (Les prompts ne seront pas supprimés)')) { 
                        storage.deleteFolder(delBtn.dataset.id); 
                        currentFolderId = 'all'; 
                        renderFolders(); 
                        renderPromptLibrary(); 
                        showToast('Dossier supprimé !', 'success');
                    } 
                }
                else if (item) { currentFolderId = item.dataset.id; renderFolders(); renderPromptLibrary(); }
            });
            
            // Prompt list listeners (for actions and modal opening)
            document.getElementById('prompt-library-list').addEventListener('click', e => {
                const card = e.target.closest('.prompt-card');
                if (!card) return;
                const promptId = card.dataset.id;
                // Check if a button or select was the target
                if (e.target.closest('button, select')) { 
                    const action = e.target.dataset.action;
                    if (action === 'copy') {
                        const prompt = storage.getPrompts().find(p=>p.id===promptId);
                        if(prompt) {
                            navigator.clipboard.writeText(prompt.content).then(()=>{
                                showToast('Prompt copié !', 'success');
                            }).catch(err => {
                                showToast('Erreur lors de la copie.', 'error');
                                console.error('Copy error:', err);
                            });
                        }
                    }
                    if (action === 'delete') {
                        if (confirm('Êtes-vous sûr de vouloir supprimer ce prompt ?')) { 
                            storage.deletePrompt(promptId); 
                            updatePromptCount(); 
                            renderPromptLibrary(); 
                            showToast('Prompt supprimé !', 'success');
                        } 
                    }
                    if (action === 'edit') {
                        startEditingPrompt(promptId);
                    }
                } else { 
                    // If not a button/select, open the modal
                    openPromptModal(promptId); 
                }
            });

            // Listener for moving a prompt to a folder
            document.getElementById('prompt-library-list').addEventListener('change', e => { 
                const sel = e.target.closest('select[data-action="move"]'); 
                if(sel){ 
                    const promptId = sel.closest('.prompt-card').dataset.id;
                    storage.updatePromptFolder(promptId, sel.value); 
                    showToast('Prompt déplacé !', 'info');
                    // Refresh list if user is not in "All" view
                    if(currentFolderId !== 'all') renderPromptLibrary(); 
                } 
            });
            
            // Import/Export listeners
            document.getElementById('export-data-btn').addEventListener('click', exportData);
            document.getElementById('import-data-btn').addEventListener('click', () => document.getElementById('import-data-input').click());
            document.getElementById('import-data-input').addEventListener('change', importData);

            // Modal listeners
            document.getElementById('modal-close-btn').addEventListener('click', closePromptModal);
            document.getElementById('prompt-modal').addEventListener('click', e => { 
                // Close if clicking on the overlay itself, not the content
                if (e.target.id === 'prompt-modal') closePromptModal(); 
            });
            
            // Main navigation
            document.querySelectorAll('.nav-item').forEach(item => item.addEventListener('click', function() { switchTab(this.getAttribute('data-tab')); }));
        }

        // =================================================================================
        // INITIALIZATION
        // =================================================================================
        document.addEventListener('DOMContentLoaded', () => { 
            setupEventListeners(); 
            updateStepDisplay(); 
            updatePromptCount(); 
        });
    </script>
</body>
</html>